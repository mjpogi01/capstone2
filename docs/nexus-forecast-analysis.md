# Nexus AI — Sales Forecast Analysis Notes

Nexus (the in-app AI assistant) can analyze whatever data we hand it. For chart analysis we pass a dataset + SQL context so the assistant understands how the chart was built. The **Sales Forecast** chart is special because it is derived from model logic, not a simple SQL aggregation. This document explains what Nexus currently sees and how we can expose the forecasting details if we want model-aware commentary.

## Current Behaviour

- When the user clicks **Analyze** on the Sales Forecast card, the UI calls `/api/ai/analytics` with `chartId: 'salesForecast'`.
- The backend (`server/routes/ai.js`) loads the forecast dataset via `getChartDataset('salesForecast', ...)`. Right now that logic still calls the SQL helper, so Nexus only sees historical sums — it does **not** see the actual forecast values or model metadata.
- Result: Nexus can describe historical revenue trends, but not the projected numbers generated by the Fourier/Holt-Winters model in `/api/analytics/sales-forecast`.

## What We’d Need for Forecast Insight

1. **Expose Forecast Output**
   - Reuse the response from `/api/analytics/sales-forecast` and pass the `forecast` array (month, projected revenue, confidence, growth rate, orders) into the Nexus payload.
   - Store a short recap of the modelling approach (Fourier regression + recency weighting) and expose it in the assistant context so Nexus can explain how the numbers were produced.

2. **Request Packet Enhancements**
   - Update `getChartDataset` (or add a forecast-specific branch) to fetch the API model output, not just the SQL sum.
   - Provide synthetic “SQL” context or a textual explanation, e.g.:
     ```
     Model type: Weighted Fourier regression with 6 harmonics
     Training window: Jan 2022 – latest complete month
     Confidence: derived from residual standard deviation
     ```
   - Include recent actuals (e.g., 2025 YTD) so the assistant can compare model vs. reality.

3. **Frontend Plumbing**
   - When the user opens Nexus for the forecast chart, pass both the historical/forecast data returned by the analytics API and an optional narrative string.
   - Existing `handleAnalyzeClick` already sends `context.data` — we just need to make sure that object contains the forecast array.

## Minimal Change Outline

1. In `/api/analytics/sales-forecast`:
   - Build a compact payload `analysisContext = { model: 'weighted_fourier', params: {...}, forecast }`.

2. In `/api/ai/analytics` (salesForecast case):
   - Instead of raw SQL, call the same forecast helper and map it into the AI response.

3. Update `getChartDataset` (chartId `'salesForecast'`) to:
   - Return `{ sql: 'N/A — model-based', rows: forecast }`.
   - Attach `metadata.summary` with baseline, growth %, confidence.

4. Frontend:
   - Ensure `handleAnalyzeClick('salesForecast', { data: salesForecast })` sends the actual model data (already stored in state after the HTTP request).

## Summary

Today, Nexus lacks the actual projection numbers because its current path only uses SQL. To let the assistant explain and validate the forecast, we need to feed it the model output and a textual description of the modelling steps. The change is mostly plumbing: reuse the forecast API’s data when the chartId is `salesForecast`. Once that’s done, AI analysis can reason about both historical and modelled revenue, highlighting whether 2025 actuals match the model, confidence levels, etc.


